---
- import_playbook: setup.yml

- name: Install Monitoring Stack
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: monitoring/setup-tasks.yml

- name: Install PostgreSQL and pgAdmin
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: postgres/setup-tasks.yml

- name: Install Kubernetes Dashboard
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: dashboard/setup-tasks.yml

- name: Install ArgoCD
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: argocd/setup-tasks.yml

- name: Install HashiCorp Vault
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: vault/setup-tasks.yml

- name: Install Jenkins
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  roles:
    - jenkins_k8s

- name: Final Validation and Summary
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - name: Wait for all pods to be ready
      command: kubectl get pods --all-namespaces
      register: pod_status
      
    - name: Display deployment summary
      debug:
        msg: |
          üéâ Complete Server Setup Finished!
          ===================================
          
          üåê Access URLs:
          ‚Ä¢ Ingress Controller: http://{{ ansible_host }}:30080
          
          üìä Services (via Ingress):
          ‚Ä¢ ArgoCD: http://shivi.local:30080/argocd
          ‚Ä¢ Grafana: http://shivi.local:30080/grafana
          ‚Ä¢ Prometheus: http://shivi.local:30080/prometheus
          ‚Ä¢ Kubernetes Dashboard: http://shivi.local:30080/dashboard
          ‚Ä¢ Jenkins: http://{{ ansible_host }}:30080/jenkins
          ‚Ä¢ Vault: http://{{ ansible_host }}:30080/vault
          
          üîê Direct Access (NodePort):
          ‚Ä¢ Jenkins: http://{{ ansible_host }}:30000
          ‚Ä¢ Vault: http://{{ ansible_host }}:30201
          ‚Ä¢ PostgreSQL: {{ ansible_host }}:32543
          ‚Ä¢ pgAdmin: http://{{ ansible_host }}:32544 (multi-device friendly)
          
          üè† Hostname Setup:
          Add to your local /etc/hosts file:
          {{ ansible_host }} shivi.local
          
          üìã Next Steps:
          1. Access ArgoCD and configure your applications
          2. Set up monitoring alerts in Grafana
          3. Configure Vault for secrets management
          4. Set up Jenkins pipelines
          5. Access pgAdmin to manage PostgreSQL databases
          
          üîß Troubleshooting:
          ‚Ä¢ Check pod status: kubectl get pods --all-namespaces
          ‚Ä¢ View logs: kubectl logs -n <namespace> <pod-name>
          ‚Ä¢ Ingress status: kubectl get ingress --all-namespaces 
---
- import_playbook: setup.yml

- name: Install Monitoring Stack
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: monitoring/setup-tasks.yml

- name: Install Kubernetes Dashboard
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: dashboard/setup-tasks.yml

- name: Install ArgoCD
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: argocd/setup-tasks.yml

- name: Install HashiCorp Vault
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: vault/setup-tasks.yml

- name: Install Jenkins
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: jenkins/setup-tasks.yml

- name: Final Validation and Summary
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - name: Wait for all pods to be ready
      command: kubectl get pods --all-namespaces
      register: pod_status
      
    - name: Display deployment summary
      debug:
        msg: |
          ğŸ‰ Complete Server Setup Finished!
          ===================================
          
          ğŸŒ Access URLs:
          â€¢ Ingress Controller: http://{{ ansible_host }}:30080
          
          ğŸ“Š Services (via Ingress):
          â€¢ ArgoCD: http://{{ ansible_host }}:30080/argocd
          â€¢ Grafana: http://{{ ansible_host }}:30080/grafana
          â€¢ Prometheus: http://{{ ansible_host }}:30080/prometheus
          â€¢ Kubernetes Dashboard: http://{{ ansible_host }}:30080/dashboard
          â€¢ Jenkins: http://{{ ansible_host }}:30080/jenkins
          â€¢ Vault: http://{{ ansible_host }}:30080/vault
          
          ğŸ” Direct Access (if needed):
          â€¢ Jenkins: http://{{ ansible_host }}:30000
          â€¢ Vault: http://{{ ansible_host }}:30201
          
          ğŸ“‹ Next Steps:
          1. Access ArgoCD and configure your applications
          2. Set up monitoring alerts in Grafana
          3. Configure Vault for secrets management
          4. Set up Jenkins pipelines
          
          ğŸ”§ Troubleshooting:
          â€¢ Check pod status: kubectl get pods --all-namespaces
          â€¢ View logs: kubectl logs -n <namespace> <pod-name>
          â€¢ Ingress status: kubectl get ingress --all-namespaces 
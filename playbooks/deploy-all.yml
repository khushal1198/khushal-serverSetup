---
- import_playbook: setup.yml

- name: Install Monitoring Stack
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: monitoring/setup-tasks.yml

- name: Install Kubernetes Dashboard
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: dashboard/setup-tasks.yml

- name: Install ArgoCD
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: argocd/setup-tasks.yml

- name: Install HashiCorp Vault
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - include_tasks: vault/setup-tasks.yml

- name: Install Jenkins
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  roles:
    - jenkins_k8s

- name: Final Validation and Summary
  hosts: servers
  become: yes
  environment:
    KUBECONFIG: "/etc/rancher/k3s/k3s.yaml"
  tasks:
    - name: Wait for all pods to be ready
      command: kubectl get pods --all-namespaces
      register: pod_status
      
    - name: Display deployment summary
      debug:
        msg: |
          üéâ Complete Server Setup Finished!
          ===================================
          
          üåê Access URLs:
          ‚Ä¢ Ingress Controller: http://{{ ansible_host }}:30080
          
          üìä Services (via Ingress):
          ‚Ä¢ ArgoCD: http://{{ ansible_host }}:30080/argocd
          ‚Ä¢ Grafana: http://{{ ansible_host }}:30080/grafana
          ‚Ä¢ Prometheus: http://{{ ansible_host }}:30080/prometheus
          ‚Ä¢ Kubernetes Dashboard: http://{{ ansible_host }}:30080/dashboard
          ‚Ä¢ Jenkins: http://{{ ansible_host }}:30080/jenkins
          ‚Ä¢ Vault: http://{{ ansible_host }}:30080/vault
          
          üîê Direct Access (if needed):
          ‚Ä¢ Jenkins: http://{{ ansible_host }}:30000
          ‚Ä¢ Vault: http://{{ ansible_host }}:30201
          
          üìã Next Steps:
          1. Access ArgoCD and configure your applications
          2. Set up monitoring alerts in Grafana
          3. Configure Vault for secrets management
          4. Set up Jenkins pipelines
          
          üîß Troubleshooting:
          ‚Ä¢ Check pod status: kubectl get pods --all-namespaces
          ‚Ä¢ View logs: kubectl logs -n <namespace> <pod-name>
          ‚Ä¢ Ingress status: kubectl get ingress --all-namespaces 